(window.webpackJsonp=window.webpackJsonp||[]).push([[10],{208:function(s,a,t){"use strict";t.r(a);var e=t(28),r=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"http-浏览器缓存机制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#http-浏览器缓存机制"}},[s._v("#")]),s._v(" HTTP 浏览器缓存机制")]),s._v(" "),t("p",[s._v("HTTP 浏览器缓存机制是 "),t("code",[s._v("HTTP/1.0")]),s._v(" 新增的，缓存会根据请求保存输出内容的副本，例如 html 页面，图片，文件，当下一个请求来到的时候：如果是相同的 URL ，缓存直接使用副本响应访问请求，或者询问服务器后直接使用副本，减少响应报文大小。")]),s._v(" "),t("p",[s._v("缓存的优点：")]),s._v(" "),t("ul",[t("li",[s._v("减少相应延迟")]),s._v(" "),t("li",[s._v("减少网络带宽消耗")])]),s._v(" "),t("h2",{attrs:{id:"第一次请求"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#第一次请求"}},[s._v("#")]),s._v(" 第一次请求")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://zhuxinyu-znb.github.io/blog/20190814-http1-4.png",alt:""}})]),s._v(" "),t("p",[s._v("第一次访问本地无缓存，故向服务器发起请求，浏览器会保存响应副本。")]),s._v(" "),t("h2",{attrs:{id:"第二次请求"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#第二次请求"}},[s._v("#")]),s._v(" 第二次请求")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://zhuxinyu-znb.github.io/blog/20190814-http1-5.png",alt:""}})]),s._v(" "),t("p",[s._v("浏览器在拿到对应的缓存文件后，根据 "),t("strong",[s._v("响应头")]),s._v(" 字段，浏览器作出不同的动作。由此分出不同的缓存类型：强缓存和协商缓存。")]),s._v(" "),t("h3",{attrs:{id:"强缓存"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#强缓存"}},[s._v("#")]),s._v(" 强缓存")]),s._v(" "),t("p",[t("strong",[s._v("强缓存")]),s._v("是根据响应头中的 "),t("code",[s._v("Cache-Control")]),s._v(" (HTTP/1.1添加) 和 "),t("code",[s._v("Expires")]),s._v(" （HTTP/1.0添加）字段做判断，二者同时存在时以 Cache-Control 作为判断。\nExpires 是绝对的过期时间。受限于本地时间，可能存在不准确问题，格式如下：")]),s._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[s._v("Expires"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("Wed"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(" Apr "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("32")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("48")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("GMT")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("Cache-Control 当值设为 "),t("code",[s._v("max-age=XXX")]),s._v(" 时，则代表在这个请求正确返回时间（浏览器也会记录下来）的 "),t("strong",[s._v("XXX秒")]),s._v(" 内再次加载资源，就会命中强缓存。\nmax-age 的单位是秒。格式如下：")]),s._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[s._v("Cache"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("Control"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("max"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("age"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("300")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("Cache-Control 有以下几个比较常用的设置值：")]),s._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[s._v("max"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("age：用来设置资源（representations）可以被缓存多长时间，单位为秒；\nno"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("cache：会缓存，但是强制客户端直接向服务器发送请求"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("也就是说每次请求都必须向服务器发送。服务器接收到请求，然后判断资源是否变更，是则返回新内容，否则返回"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("304")]),s._v("，未变更。这个很容易让人产生误解，使人误以为是响应不被缓存。实际上 "),t("span",{pre:!0,attrs:{class:"token template-string"}},[t("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[s._v("`")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("Cache-Control:no-cache")]),t("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[s._v("`")])]),s._v(" 是会被缓存的，只不过每次在向客户端（浏览器）提供响应数据时，缓存都要向服务器评估缓存响应的有效性。\nno"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("store：禁止一切缓存（这个才是响应不被缓存的意思）。\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v("：指示响应可被任何缓存区缓存；\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v("：只能针对个人用户，而不能被代理服务器缓存；\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("在命中强缓存后，浏览器不会向服务器发送任何请求，直接从本地缓存中读取文件并返回 "),t("code",[s._v("Status Code: 200 OK")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/04/19/c8jUH6NSgMaiGnE.jpg",alt:""}}),s._v(" "),t("img",{attrs:{src:"https://i.loli.net/2020/04/19/9b63se14NEjBcLI.jpg",alt:""}})]),s._v(" "),t("p",[s._v("优先访问 "),t("code",[s._v("memory cache")]),s._v(" ,其次是 "),t("code",[s._v("disk cache")]),s._v(", 最后是请求网络资源，"),t("code",[s._v("memory cache")]),s._v(" 在浏览器关闭后就被清空。")]),s._v(" "),t("h3",{attrs:{id:"协商缓存"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#协商缓存"}},[s._v("#")]),s._v(" 协商缓存")]),s._v(" "),t("p",[s._v("当未命中强缓存时，即在 Cache-Control 的 max-age 时间已过，Cache-Control 为 no-cache ，或 Expires 绝对过期时间之外。此时浏览器会带上缓存中响应头里的几个字段，向服务器发起请求，让服务器来决定缓存是否可用。")]),s._v(" "),t("p",[s._v("缓存中的响应头的关于协商缓存的两个字段：ETag 和 Last-Modified，请求时这两个字段的值会以不同的字段名带回去，对应关系如下：")]),s._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[s._v("ETag               "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("    If"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("None"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("Match\nLast"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("Modified      "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("    If"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("Modified"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("Since\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("Etag 是属于 HTTP 1.1属性，它就像一个指纹，资源变化都会导致 ETag 变化，跟最后修改时间没有关系，ETag 可以保证每一个资源是唯一的。")]),s._v(" "),t("p",[s._v("If-None-Match 会将上次返回的 Etag 发送给服务器，询问该资源的 Etag 是否有更新。\n当有变动就会发送新的资源回来，状态码为 200，浏览器使用新资源；若服务器判断为缓存可用，则 状态码为 304，响应体为空，浏览器使用缓存。")]),s._v(" "),t("p",[s._v("Last-Modified 缓存文件最后修改日期")]),s._v(" "),t("p",[s._v("If-Modified-Since 上次返回的 Last-Modified 的值，询问服务器在该日期后资源是否有更新，有更新的话就会将新的资源发送回来。无更新则返回 状态码为 304，响应体为空，浏览器使用缓存。")]),s._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("、Last"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("Modifed"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("If"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("Modified"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("Since 的时间精度是秒，而 Etag 可以更精确。\n\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("、Etag 优先级是高于 Last"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("Modifed 的，所以服务器会优先验证 Etag\n\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("、Last"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("Modifed"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("If"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("Modified"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("Since 是 http1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" 的头字段\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("至此，整个缓存的流程如下\n"),t("img",{attrs:{src:"https://i.loli.net/2020/04/19/HE6BjC1SxI7krY4.png",alt:""}})]),s._v(" "),t("h2",{attrs:{id:"小故事"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#小故事"}},[s._v("#")]),s._v(" 小故事")]),s._v(" "),t("p",[s._v("最后借用一则"),t("a",{attrs:{href:"http://jartto.wang/2019/02/14/web-cache/",target:"_blank",rel:"noopener noreferrer"}},[s._v("故事"),t("OutboundLink")],1),s._v("故事来加深理解")]),s._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[s._v("故事一：Last"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("Modified\n浏览器：Hi，我需要 xxx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("js 这个文件，如果是在 Last"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("Modified"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Fri Feb "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("57")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("31")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("GMT")]),s._v(" 之后修改过的，请发给我。\n服务器：（检查文件的修改时间）\n服务器：Oh，这个文件在那个时间之后没有被修改过，你已经有最新的版本了。\n浏览器：太好了，那我就显示给用户了。\n\n故事二：ETag\n浏览器：Hi，我需要 xxx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("css 这个文件，有没有不匹配 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("c61f"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("c1"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("aecb436 这个串的\n服务器：（检查 ETag…）\n服务器：Hey，我这里的版本也是 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("c61f"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("c1"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("aecb436，你已经是最新的版本了\n浏览器：好，那就可以使用本地缓存了\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("h2",{attrs:{id:"参考文章"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#参考文章"}},[s._v("#")]),s._v(" 参考文章")]),s._v(" "),t("p",[t("a",{attrs:{href:"http://jartto.wang/2019/02/14/web-cache/",target:"_blank",rel:"noopener noreferrer"}},[s._v("聊一聊浏览器缓存机制"),t("OutboundLink")],1)]),s._v(" "),t("p",[t("a",{attrs:{href:"https://juejin.im/post/5ccfccaff265da03ab233bf5",target:"_blank",rel:"noopener noreferrer"}},[s._v("http面试必会的：强制缓存和协商缓存"),t("OutboundLink")],1)])])}),[],!1,null,null,null);a.default=r.exports}}]);